**http建立连接过程**

1. 客户端向服务端发送请求报文
2. 服务端根据请求报文收集对应的资源组合成响应报文
3. 客户端收到响应报文，进行解析

**tcp三次握手连接过程**

1. 客户端发送SYN到服务端，等待确认
2. 服务端向客户端返回ACK，同时自己也发送一个SYN包，即SYN+ACK包
3. 客户端收到回应，向服务端发送确认包ACK
4. 完成三次握手，客户端与服务器开始传送数据

**tcp四次挥手断开连接过程**

1. 客户端发送FIN，提醒服务端自己准备关闭通信
2. 服务端收到FIN，回应ACK
3. 服务端发送FIN，提醒客户端自己准备关闭通信
4. 客户端收到ACK+FIN，回应一个ACK
5. 四次挥手完毕，关闭连接

首先http是一个应用层的传输协议，而https是基于ssl和tls对http做了一个加密过程，因此https是跨应用层和传输层的协议。

**下图是https的整个流程。**[[1\]](https://zhuanlan.zhihu.com/p/79367346#ref_1)

![img](https://pic1.zhimg.com/80/v2-d3b43a0ab493a761d7a3603b006316c8_720w.jpg)

1. 客户端向服务端发送一个招呼报文（hello），包含自己支持的SSL版本，加密算法等信息。

2. 服务端回复一个招呼报文（hi）包含自己支持的SSL版本，加密算法等信息。

3. 服务端发送自己经过CA认证的公开密钥

4. 1. 服务端向CA认证机构发送自己的公开密钥（FPkey）
   2. CA认证机构使用自己的私有密钥给FPkey加上签名返回给服务端

5. 服务端发送结束招呼的报文，SSL第一次握手结束。

6. 客户端使用FPkey对自己的随机密码串（Ckey）进行加密并发送给服务端

7. 1. 客户端首先使用CA的公开密钥对FPkey的签名进行认证，确认密钥未被替换

8. 客户端发送提示报文，后续报文将用Ckey进行加密。

9. 客户端发送finished报文，表示该次发送结束

10. 1. 后续是否通信取决于客户端的finished报文能否被服务端成功解密

11. 服务端发送提示报文，表示他之后的报文也会用Ckey进行加密

12. 服务端发送finished报文。至此SSL握手结束，成功建立SSL连接。

13. 客户端开始发送http请求报文

14. 1. 建立Tcp连接，开始传输数据

15. 服务端发送http回复报文

16. 客户端发送断开连接报文，并断开Tcp连接



-------------------------------------------------------------------------------------------------------------

HTTP 有以下安全性问题：

- 使用明文进行通信，内容可能会被窃听；
- 不验证通信方的身份，通信方的身份有可能遭遇伪装；
- 无法证明报文的完整性，报文有可能遭篡改。

HTTPS 并不是新协议，而是让 HTTP 先和 SSL（Secure Sockets Layer）通信，再由 SSL 和 TCP 通信，也就是说 HTTPS 使用了隧道进行通信。

通过使用 SSL，HTTPS 具有了加密（防窃听）、认证（防伪装）和完整性保护（防篡改）。

![img](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/ssl-offloading.jpg)



## 加密

### 1. 对称密钥加密

对称密钥加密（Symmetric-Key Encryption），加密和解密使用同一密钥。

- 优点：运算速度快；
- 缺点：无法安全地将密钥传输给通信方。

![img](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/7fffa4b8-b36d-471f-ad0c-a88ee763bb76.png)



### 2.非对称密钥加密

非对称密钥加密，又称公开密钥加密（Public-Key Encryption），加密和解密使用不同的密钥。

公开密钥所有人都可以获得，通信发送方获得接收方的公开密钥之后，就可以使用公开密钥进行加密，接收方收到通信内容后使用私有密钥解密。

非对称密钥除了用来加密，还可以用来进行签名。因为私有密钥无法被其他人获取，因此通信发送方使用其私有密钥进行签名，通信接收方使用发送方的公开密钥对签名进行解密，就能判断这个签名是否正确。

- 优点：可以更安全地将公开密钥传输给通信发送方；
- 缺点：运算速度慢。

![img](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/39ccb299-ee99-4dd1-b8b4-2f9ec9495cb4.png)



### 3. HTTPS 采用的加密方式

上面提到对称密钥加密方式的传输效率更高，但是无法安全地将密钥 Secret Key 传输给通信方。而非对称密钥加密方式可以保证传输的安全性，因此我们可以利用非对称密钥加密方式将 Secret Key 传输给通信方。HTTPS 采用混合的加密机制，正是利用了上面提到的方案：

- 使用非对称密钥加密方式，传输对称密钥加密方式所需要的 Secret Key，从而保证安全性;
- 获取到 Secret Key 后，再使用对称密钥加密方式进行通信，从而保证效率。（下图中的 Session Key 就是 Secret Key）

![img](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/How-HTTPS-Works.png)



## 认证

通过使用 **证书** 来对通信方进行认证。

数字证书认证机构（CA，Certificate Authority）是客户端与服务器双方都可信赖的第三方机构。

服务器的运营人员向 CA 提出公开密钥的申请，CA 在判明提出申请者的身份之后，会对已申请的公开密钥做数字签名，然后分配这个已签名的公开密钥，并将该公开密钥放入公开密钥证书后绑定在一起。

进行 HTTPS 通信时，服务器会把证书发送给客户端。客户端取得其中的公开密钥之后，先使用数字签名进行验证，如果验证通过，就可以开始通信了。

![img](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/2017-06-11-ca.png)



## 完整性保护

SSL 提供报文摘要功能来进行完整性保护。

HTTP 也提供了 MD5 报文摘要功能，但不是安全的。例如报文内容被篡改之后，同时重新计算 MD5 的值，通信接收方是无法意识到发生了篡改。

HTTPS 的报文摘要功能之所以安全，是因为它结合了加密和认证这两个操作。试想一下，加密之后的报文，遭到篡改之后，也很难重新计算报文摘要，因为无法轻易获取明文。

## HTTPS 的缺点

- 因为需要进行加密解密等过程，因此速度会更慢；
- 需要支付证书授权的高额费用。